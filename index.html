<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rúbrica de Evaluación: Bloque de Nutrición</title>
    <style>
        /* --- Estilos Generales --- */
        body {
            font-family: 'Roboto', 'Lato', 'Open Sans', sans-serif;
            background-color: #f4f7f9;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 20px auto;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        h1, h2 {
            color: #0d47a1;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        h1 { text-align: center; font-size: 2em; }
        h2 { font-size: 1.5em; margin-top: 30px; }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .info-item { display: flex; flex-direction: column; }
        .info-item label { font-weight: bold; color: #555; margin-bottom: 5px; }
        .info-item input[type="text"], .info-item input[type="date"] {
            padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1em;
        }

        .rubric-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .rubric-table th, .rubric-table td { padding: 15px; text-align: left; border-bottom: 1px solid #ddd; }
        .rubric-table th { background-color: #e3f2fd; color: #0d47a1; font-size: 1.1em; }
        .criterion-title { font-weight: bold; font-size: 1.2em; color: #1565c0; }
        .level-cell { text-align: center; vertical-align: middle; }
        .level-cell input[type="radio"] { transform: scale(1.5); cursor: pointer; }

        .final-section { margin-top: 40px; }
        textarea { width: 100%; height: 120px; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 1em; resize: vertical; }
        .controls { text-align: center; margin-top: 30px; }
        #calculateBtn, #saveBtn { background-color: #1976d2; color: white; padding: 15px 30px; border: none; border-radius: 8px; font-size: 1.2em; cursor: pointer; transition: background-color 0.3s ease; margin: 6px 8px; }
        #calculateBtn:hover, #saveBtn:hover { background-color: #1565c0; }
        #result { margin-top: 12px; text-align: center; font-size: 1.4em; font-weight: 700; color: #0d47a1; min-height: 28px; }
        #statusMsg { margin-top: 12px; text-align: center; color: #2e7d32; min-height: 22px; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 20px; }
            .rubric-table, .rubric-table thead, .rubric-table tbody, .rubric-table th, .rubric-table td, .rubric-table tr { display: block; }
            .rubric-table thead tr { position: absolute; top: -9999px; left: -9999px; }
            .rubric-table tr { border: 1px solid #ccc; margin-bottom: 15px; border-radius: 8px; overflow: hidden; }
            .rubric-table td { border: none; border-bottom: 1px solid #eee; position: relative; padding-left: 50%; text-align: right; }
            .rubric-table td:before { position: absolute; top: 50%; left: 15px; width: 45%; padding-right: 10px; white-space: nowrap; transform: translateY(-50%); text-align: left; font-weight: bold; color: #555; }
            .rubric-table td[data-label="Excelente"]::before { content: "Excelente"; }
            .rubric-table td[data-label="Satisfactorio"]::before { content: "Satisfactorio"; }
            .rubric-table td[data-label="Mejorable"]::before { content: "Mejorable"; }
            .rubric-table td[data-label="Deficiente"]::before { content: "Deficiente"; }
            .rubric-table .description-cell { padding-left: 15px; text-align: left; }
            .rubric-table .description-cell::before { content: ""; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Rúbrica de Evaluación: Bloque de Nutrición en Cuidados Intensivos</h1>

        <div class="info-grid">
            <div class="info-item">
                <label for="resident">Residente:</label>
                <input type="text" id="resident" value="Dr. José Indalecio López Zamorán" readonly>
            </div>
            <div class="info-item">
                <label for="evalDate">Fecha de Evaluación:</label>
                <input type="date" id="evalDate">
            </div>
            <div class="info-item">
                <label for="classTopic">Tema de la Clase:</label>
                <input type="text" id="classTopic" placeholder="Ingrese el tema...">
            </div>
            <div class="info-item">
                <label for="evaluator">Evaluador:</label>
                <input type="text" id="evaluator" placeholder="Ingrese su nombre...">
            </div>
        </div>

        <h2>CRITERIOS DE EVALUACIÓN</h2>

        <form id="rubricForm">
            <table class="rubric-table">
                <thead>
                    <tr>
                        <th>Criterio</th>
                        <th>Excelente (4)</th>
                        <th>Satisfactorio (3)</th>
                        <th>Mejorable (2)</th>
                        <th>Deficiente (1)</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Criterio 1 -->
                    <tr>
                        <td class="description-cell">
                            <span class="criterion-title">1. Contenido Científico y Adecuación al Paciente Crítico</span>
                            <p><b>Excelente:</b> Presenta un contenido riguroso, relevante y actualizado, demostrando un dominio excepcional del tema. Aborda de forma exhaustiva las causas y consecuencias de la desnutrición, métodos de tamizaje, requerimientos nutricionales, y manejo en patologías específicas. Incluye conceptos avanzados como inmunonutrición.</p>
                            <p><b>Satisfactorio:</b> El contenido es riguroso y relevante, cubriendo los aspectos fundamentales. Demuestra un buen conocimiento general, aunque podría profundizar en ciertos detalles o actualizaciones.</p>
                            <p><b>Mejorable:</b> El contenido presenta algunas imprecisiones o es limitado en profundidad. Faltan detalles sobre la evaluación, requerimientos o manejo en situaciones complejas.</p>
                            <p><b>Deficiente:</b> El contenido es superficial, presenta errores significativos o no es adecuado para la formación. Demuestra un conocimiento insuficiente de los principios básicos.</p>
                        </td>
                        <td class="level-cell" data-label="Excelente"><input type="radio" name="criterio1" value="4" required></td>
                        <td class="level-cell" data-label="Satisfactorio"><input type="radio" name="criterio1" value="3"></td>
                        <td class="level-cell" data-label="Mejorable"><input type="radio" name="criterio1" value="2"></td>
                        <td class="level-cell" data-label="Deficiente"><input type="radio" name="criterio1" value="1"></td>
                    </tr>
                    <!-- Criterio 2 -->
                    <tr>
                        <td class="description-cell">
                             <span class="criterion-title">2. Habilidades de Comunicación y Presentación Oral</span>
                            <p><b>Excelente:</b> Se comunica de manera efectiva, clara y persuasiva. Mantiene excelente contacto visual, modulación de voz y gestos. El material de apoyo visual es de alta calidad, legible y bien organizado. La estructura de la clase es lógica y balanceada.</p>
                            <p><b>Satisfactorio:</b> Se comunica de manera adecuada y clara. Las habilidades verbales y no verbales son buenas. El material de apoyo es funcional, con pequeños detalles mejorables. La estructura es clara.</p>
                            <p><b>Mejorable:</b> Presenta algunas dificultades en la comunicación (claridad, persuasión). Aspectos verbales o no verbales podrían mejorar. El material de apoyo o la estructura podrían ser más efectivos.</p>
                            <p><b>Deficiente:</b> Dificultades notables para comunicarse de manera efectiva. El mensaje es confuso. El material de apoyo es deficiente y la estructura de la clase es desorganizada.</p>
                        </td>
                        <td class="level-cell" data-label="Excelente"><input type="radio" name="criterio2" value="4" required></td>
                        <td class="level-cell" data-label="Satisfactorio"><input type="radio" name="criterio2" value="3"></td>
                        <td class="level-cell" data-label="Mejorable"><input type="radio" name="criterio2" value="2"></td>
                        <td class="level-cell" data-label="Deficiente"><input type="radio" name="criterio2" value="1"></td>
                    </tr>
                    <!-- Criterio 3 -->
                    <tr>
                        <td class="description-cell">
                            <span class="criterion-title">3. Manejo de Casos Clínicos y Controversias</span>
                            <p><b>Excelente:</b> Discute de forma experta la terapia nutricional mediante casos clínicos relevantes. Reconoce y aborda las principales controversias actuales, fundamentando las decisiones con bibliografía reciente.</p>
                            <p><b>Satisfactorio:</b> Presenta casos clínicos relevantes y discute la aplicación de la terapia. Identifica algunas controversias, pero la profundidad del análisis podría ser mayor.</p>
                            <p><b>Mejorable:</b> La presentación de casos clínicos es limitada o poco ilustrativa. No profundiza en las controversias o las aborda de manera superficial.</p>
                            <p><b>Deficiente:</b> No utiliza casos clínicos o los presentados son irrelevantes. No aborda las controversias o las presenta de forma incorrecta.</p>
                        </td>
                        <td class="level-cell" data-label="Excelente"><input type="radio" name="criterio3" value="4" required></td>
                        <td class="level-cell" data-label="Satisfactorio"><input type="radio" name="criterio3" value="3"></td>
                        <td class="level-cell" data-label="Mejorable"><input type="radio" name="criterio3" value="2"></td>
                        <td class="level-cell" data-label="Deficiente"><input type="radio" name="criterio3" value="1"></td>
                    </tr>
                    <!-- Criterio 4 -->
                    <tr>
                        <td class="description-cell">
                            <span class="criterion-title">4. Aplicación Práctica y Recomendaciones</span>
                            <p><b>Excelente:</b> Proporciona recomendaciones claras y basadas en evidencia, detallando el "cuándo", "qué" y "cómo" iniciar la terapia. Discute de forma crítica el manejo de complicaciones y mitos comunes (ej. residuo gástrico, uso de vasopresores).</p>
                            <p><b>Satisfactorio:</b> Ofrece recomendaciones prácticas alineadas con las guías. Reconoce los factores clave para la implementación y el manejo de complicaciones, pero podría ser más específico.</p>
                            <p><b>Mejorable:</b> Las recomendaciones son genéricas o carecen de especificidad. Algunos aspectos del monitoreo o manejo de complicaciones no son abordados o son incompletos.</p>
                            <p><b>Deficiente:</b> Las recomendaciones son incorrectas, incompletas o no están basadas en la evidencia. Demuestra una comprensión deficiente de la implementación práctica.</p>
                        </td>
                        <td class="level-cell" data-label="Excelente"><input type="radio" name="criterio4" value="4" required></td>
                        <td class="level-cell" data-label="Satisfactorio"><input type="radio" name="criterio4" value="3"></td>
                        <td class="level-cell" data-label="Mejorable"><input type="radio" name="criterio4" value="2"></td>
                        <td class="level-cell" data-label="Deficiente"><input type="radio" name="criterio4" value="1"></td>
                    </tr>
                    <!-- Criterio 5 -->
                    <tr>
                        <td class="description-cell">
                            <span class="criterion-title">5. Interacción y Retroalimentación</span>
                            <p><b>Excelente:</b> Fomenta activamente la participación, responde a preguntas de manera clara y basada en evidencia. Crea un ambiente de aprendizaje confortable, receptivo y promueve la discusión.</p>
                            <p><b>Satisfactorio:</b> Permite preguntas y responde adecuadamente. La interacción es presente pero podría ser más dinámica. El ambiente de aprendizaje es positivo.</p>
                            <p><b>Mejorable:</b> La interacción con la audiencia es limitada. Las respuestas pueden ser incompletas o la gestión del tiempo para la discusión es ineficiente.</p>
                            <p><b>Deficiente:</b> No hay interacción con la audiencia o la gestión de preguntas es ineficaz. No se promueve la discusión ni la reflexión.</p>
                        </td>
                        <td class="level-cell" data-label="Excelente"><input type="radio" name="criterio5" value="4" required></td>
                        <td class="level-cell" data-label="Satisfactorio"><input type="radio" name="criterio5" value="3"></td>
                        <td class="level-cell" data-label="Mejorable"><input type="radio" name="criterio5" value="2"></td>
                        <td class="level-cell" data-label="Deficiente"><input type="radio" name="criterio5" value="1"></td>
                    </tr>
                </tbody>
            </table>
        </form>

        <div class="final-section">
            <h2>Observaciones y Sugerencias Adicionales</h2>
            <textarea id="comments" placeholder="Añada aquí sus comentarios cualitativos..."></textarea>

            <div class="controls">
                <button id="calculateBtn">Calcular Nota Final</button>
                <button id="saveBtn" type="button">Guardar en Google Sheets</button>
                <div id="result"></div>
                <div id="statusMsg"></div>
            </div>
        </div>
    </div>

    <!-- jsPDF (sin SRI) + cache-buster y fallback -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js?v=20250825-1"></script>
    <script>
      (function ensureJsPDF(){
        function hasJsPDF(){ return !!(window.jspdf && window.jspdf.jsPDF); }
        if (hasJsPDF()) return;
        var s = document.createElement('script');
        s.src = 'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js';
        s.async = true;
        s.onload = function(){ if (!hasJsPDF()) console.error('jsPDF no se cargó correctamente.'); };
        s.onerror = function(){ console.error('Fallo al cargar jsPDF desde CDN alterno.'); };
        document.head.appendChild(s);
      })();
    </script>

    <script>
        // URL del Web App de Google Apps Script
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz_LbzQdwPUHRrwskjkhqYzHmKSlEO6qQSwzQTku3Vnc5c6iCC80kTTtAeqbp1h0Rcksw/exec';

        function getSelectedValue(groupOrElement) {
            if (!groupOrElement) return null;
            const list = (typeof groupOrElement.length === 'number') ? Array.from(groupOrElement) : [groupOrElement];
            const checked = list.find(el => el && el.checked);
            return checked ? parseInt(checked.value, 10) : null;
        }

        function calculateScore() {
            const form = document.getElementById('rubricForm');
            const criteriaCount = 5;
            let totalScore = 0;
            const selections = [];

            for (let i = 1; i <= criteriaCount; i++) {
                const radios = form.elements['criterio' + i];
                const selected = getSelectedValue(radios);
                selections.push(selected);
                if (selected != null) totalScore += selected;
            }

            const maxScore = criteriaCount * 4;
            const percentage = (totalScore / maxScore) * 100;
            const complete = selections.every(v => v != null);
            return { totalScore, percentage, selections, complete, criteriaCount };
        }

        function updateLiveResult() {
            const resultDiv = document.getElementById('result');
            const { percentage, complete } = calculateScore();
            if (!complete) {
                const { selections } = calculateScore();
                const chosen = selections.filter(v => v != null).length;
                resultDiv.textContent = `Progreso: ${chosen}/5 criterios seleccionados`;
            } else {
                resultDiv.textContent = `Nota Final: ${percentage.toFixed(0)}%`;
            }
        }

        function collectRubricData() {
            const { totalScore, percentage, selections, complete } = calculateScore();
            return {
                resident: document.getElementById('resident').value.trim(),
                evalDate: document.getElementById('evalDate').value,
                classTopic: document.getElementById('classTopic').value.trim(),
                evaluator: document.getElementById('evaluator').value.trim(),
                comments: document.getElementById('comments').value.trim(),
                selections,
                totalScore,
                percentage: Math.round(percentage),
                complete,
                timestamp: new Date().toISOString()
            };
        }

        function showMissingAlert(selections) {
            const missing = selections.map((v, idx) => v == null ? (idx + 1) : null).filter(Boolean).join(', ');
            if (missing) alert(`Falta seleccionar los criterios: ${missing} (son 5 en total).`);
        }

        // Genera un PDF simple con jsPDF y retorna { filename, base64 }
        function generatePdf(data) {
            const jsPDFCtor = window.jspdf && window.jspdf.jsPDF;
            if (!jsPDFCtor) {
                throw new Error('jsPDF no está disponible aún. Recargue la página (Ctrl+F5).');
            }
            const doc = new jsPDFCtor({ unit: 'pt', format: 'a4' });

            const margin = 48;
            let y = margin;
            const line = (text, size = 12, bold = false) => {
                doc.setFont('helvetica', bold ? 'bold' : 'normal');
                doc.setFontSize(size);
                const lines = doc.splitTextToSize(text, 595 - margin * 2);
                doc.text(lines, margin, y);
                y += lines.length * (size + 4);
            };

            line('Rúbrica de Evaluación: Bloque de Nutrición en UCI', 16, true);
            line(`Residente: ${data.resident}`, 12, true);
            line(`Evaluador: ${data.evaluator}    Fecha: ${data.evalDate || new Date().toLocaleDateString()}`);
            line(`Tema de la clase: ${data.classTopic}`);
            y += 6;
            line(`Resultados`, 14, true);
            line(`Criterios (1-5): ${data.selections.map(v => v ?? '-').join('  |  ')}`);
            line(`Puntuación total: ${data.totalScore} / 20`);
            line(`Nota final: ${data.percentage}%`, 14, true);
            y += 6;
            line('Observaciones:', 12, true);
            line(data.comments || '(sin observaciones)');

            const dataUri = doc.output('datauristring');
            const base64 = dataUri.split(',')[1];
            const safe = s => (s || '').replace(/[^a-z0-9\-_. ]/gi, '_').slice(0, 80);
            const date = new Date();
            const stamp = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}_${String(date.getHours()).padStart(2,'0')}${String(date.getMinutes()).padStart(2,'0')}`;
            const filename = `Rubrica_Nutricion_${safe(data.resident)}_${stamp}.pdf`;
            return { filename, base64, dataUri };
        }

        function triggerDownload(filename, dataUri) {
            const a = document.createElement('a');
            a.href = dataUri;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
        }

        async function sendToAppsScript(payload) {
            const statusMsg = document.getElementById('statusMsg');
            statusMsg.style.color = '#2e7d32';
            statusMsg.textContent = 'Enviando datos...';
            try {
                const body = new URLSearchParams({ payload: JSON.stringify(payload) });
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
                    body
                });
                statusMsg.textContent = 'Guardado enviado. Verifique la hoja y la carpeta de Drive.';
            } catch (err) {
                statusMsg.style.color = '#c62828';
                statusMsg.textContent = 'Error al enviar. Revise el Web App de Google.';
                console.error(err);
            }
        }

        // Eventos
        document.getElementById('calculateBtn').addEventListener('click', function(event) {
            event.preventDefault();
            const { complete, selections } = calculateScore();
            if (!complete) { showMissingAlert(selections); return; }
            updateLiveResult();
        });

        // Live update al seleccionar radios
        document.querySelectorAll('input[type="radio"]').forEach(r => r.addEventListener('change', updateLiveResult));

        document.getElementById('saveBtn').addEventListener('click', function() {
            const data = collectRubricData();
            if (!data.complete) { showMissingAlert(data.selections); return; }
            if (!SCRIPT_URL) { alert('Falta configurar la URL del Web App de Google.'); return; }

            try {
              const pdf = generatePdf(data);
              triggerDownload(pdf.filename, pdf.dataUri); // Descarga local inmediata
              const payload = { ...data, generatePdf: true, pdfFilename: pdf.filename, pdfBase64: pdf.base64 };
              sendToAppsScript(payload);
            } catch (e) {
              const statusMsg = document.getElementById('statusMsg');
              statusMsg.style.color = '#c62828';
              statusMsg.textContent = 'No se pudo generar el PDF (jsPDF). Actualice la página (Ctrl+F5).';
              console.error(e);
            }
        });

        // Inicializa feedback
        updateLiveResult();
    </script>

</body>
</html>